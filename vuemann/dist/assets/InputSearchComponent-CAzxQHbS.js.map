{"version":3,"file":"InputSearchComponent-CAzxQHbS.js","sources":["../../src/services/form/views/inputs/InputSearchComponent.vue"],"sourcesContent":["<script setup>\r\nimport { ref, useSlots, watch, onUnmounted } from \"vue\";\r\nimport ErrorForm from \"@brugmann/vuemann/src/services/form/views/ErrorFormComponent.vue\"\r\nimport Dropdown from \"@brugmann/vuemann/src/components/DropdownComponent.vue\";\r\nimport { formStore } from \"@brugmann/vuemann/src/services/form/src/form-store.js\";\r\nimport { t, log } from \"@brugmann/vuemann/src/services/services-helper.js\";\r\nimport { FormHelper } from \"@brugmann/vuemann/src/services/form/form-helper.js\"\r\n\r\nconst props = defineProps({\r\n  name: {type: String, required : true },\r\n  label: {type: String, required : true},\r\n  cb: {type: Function, required : true },\r\n  minLenght: {type: Number, default: 1},\r\n  minLenghtError : { type: String, default: undefined},\r\n  pattern: { type: RegExp, default: undefined },\r\n  displayError : { type: Boolean, default: true },\r\n  form: { type: String, default: undefined },\r\n  required: { type: Boolean, default: false },\r\n  noResult: { type: String, default: undefined },\r\n})\r\n\r\nconst search = defineModel({type: String, default: \"\"})\r\nwatch(search, value => { \r\n  if(value.length > 0) { return }\r\n\r\n  formStore.clearError(props.name) \r\n  items.value = []\r\n})\r\n\r\nconst loading = ref(false)\r\nconst dropdown = ref()\r\nconst slots = useSlots()\r\nconst items = ref([])\r\nconst hasDefaultSlot = Boolean(slots.default)\r\n\r\nlet timeout_id\r\nconst DELAY_MS = 500\r\nconst runCallback = async () => {\r\n  if(search.value.length === 0 || typeof search.value !== \"string\") { resetSearch(); return }\r\n\r\n  loading.value = true\r\n  formStore.clearError(props.name)\r\n  if (timeout_id !== null) { clearTimeout(timeout_id) }\r\n  \r\n  timeout_id = setTimeout(delayCallback, DELAY_MS)\r\n}\r\n\r\nconst delayCallback = async () => {\r\n    if(search.value.length < props.minLenght) {  handleInvalidSearch(); return }\r\n\r\n    try {\r\n      items.value = await props.cb(search.value)\r\n      if(hasDefaultSlot && items.value !== undefined ) { toggleDropdown(items.value.length > 0 || props.noResult !== undefined) }\r\n\r\n    } catch (error) {\r\n      items.value = []\r\n\r\n      if(import.meta.env[`VITE_ENV`] === 'prod') {\r\n        log.send('Erreur lors de la recherche:', error)\r\n        formStore.addflash.error(props.name, t('input_search.error_search'))\r\n        return\r\n      }\r\n\r\n      //eslint-disable-next-line no-console\r\n      console.flash.error('Erreur lors de la recherche:', error)\r\n    } finally {\r\n      loading.value = false\r\n    }\r\n}\r\n\r\nconst handleInvalidSearch = () => {\r\n  if(search.value.length > 0) { \r\n    formStore.addflash.error(props.name, props.minLenghtError ?? t('input_search.error_min_length', {length : props.minLenght})) \r\n  }\r\n  \r\n  resetSearch()\r\n}\r\n\r\nconst resetSearch = () => {\r\n  items.value = []\r\n  loading.value = false\r\n  toggleDropdown(false)\r\n}\r\n\r\nconst toggleDropdown = state => { \r\n  dropdown.value.toggle(state)\r\n}\r\n\r\nconst setItems = value => {\r\n  items.value = value\r\n  if (hasDefaultSlot) { toggleDropdown(items.value.length > 0) }\r\n}\r\n\r\nconst setSearch = (value = '') => {\r\n  search.value = value\r\n}\r\n\r\nconst inputSearch = ref()\r\nconst focus = () => {\r\n  inputSearch.value.focus();\r\n}\r\n\r\nconst preventKey = event => {\r\n  if(props.pattern === undefined || props.pattern.test(String.fromCodePoint(event.keyCode))) { return true }\r\n  event.preventDefault()\r\n  return false\r\n}\r\n\r\nonUnmounted(() => {\r\n  if (timeout_id === undefined) { return }\r\n  clearTimeout(timeout_id)\r\n})\r\n\r\ndefineExpose({ runCallback, toggleDropdown, setItems, setSearch, focus})\r\n</script>\r\n\r\n<template>\r\n  <Dropdown \r\n    ref=\"dropdown\" \r\n    classes=\"left\"\r\n    :autoToggle=\"false\"\r\n  >\r\n    <template v-slot:button >\r\n      <div \r\n        class=\"input-search\"\r\n        :class=\"{searching: loading}\"\r\n      >\r\n        <input\r\n          ref=\"inputSearch\"\r\n          :id=\"FormHelper.getInputName(name, form)\"\r\n          :name=\"FormHelper.getInputName(name, form)\"\r\n          class=\"form-input input\"\r\n          type=\"search\"\r\n          v-model=\"search\"\r\n          @input=\"runCallback\"\r\n          @keypress=\"preventKey\"\r\n          @focus=\"toggleDropdown(search.length > 0 && (items?.length > 0 || noResult !== undefined))\"\r\n          autocomplete=\"off\"\r\n          placeholder=\"\"\r\n        />\r\n        <label \r\n          :for=\"FormHelper.getInputName(name, form)\" \r\n          class=\"form-label\" \r\n          :class=\"{required: required}\"\r\n        >\r\n          {{ label }}\r\n        </label>\r\n        <ErrorForm \r\n          v-if=\"displayError === true && formStore.hasError(FormHelper.getInputName(name, form))\"\r\n          :name=\"FormHelper.getInputName(name, form)\" \r\n        />\r\n      </div>\r\n    </template>\r\n    <template v-slot:items>\r\n      <slot :items=\"items\" v-if=\"items.length > 0\"></slot>\r\n      <p v-if=\"noResult && items.length === 0\" class=\"text-center my-5 fw-700 color-neutral-500\">\r\n        {{ t(noResult) }}\r\n      </p>\r\n    </template>\r\n  </Dropdown>\r\n</template>\r\n\r\n<style lang=\"scss\">\r\n  .input-search.searching input[type=\"search\"]::-webkit-search-cancel-button {\r\n    display: none;\r\n  }\r\n</style>\r\n"],"names":["DELAY_MS","props","__props","search","_useModel","watch","value","formStore","items","loading","ref","dropdown","slots","useSlots","hasDefaultSlot","timeout_id","runCallback","resetSearch","delayCallback","handleInvalidSearch","toggleDropdown","error","t","state","setItems","setSearch","inputSearch","focus","preventKey","event","onUnmounted","__expose","_createBlock","Dropdown","_createElementVNode","_normalizeClass","_unref","FormHelper","$event","_cache","_hoisted_2","ErrorForm","_renderSlot","_ctx","_openBlock","_createElementBlock","_hoisted_3","_toDisplayString"],"mappings":"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"}